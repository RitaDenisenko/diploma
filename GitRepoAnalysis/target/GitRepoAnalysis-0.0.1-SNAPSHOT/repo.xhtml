<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<link type="text/css" rel="stylesheet"  href="css/styles.css"></link>
  </head>
  <body>
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <h:form>
		<h3 style="font-weight: bold; font-size: 30px; font-family: Verdana, Arial, Helvetica, sans-serif; color: #2F4F4F; text-align: center;">Анализ &laquo;фактора автобуса&raquo;<br/>на основе гит репозитория</h3>
		<br/>
		<br/>
		<h:panelGrid columns="2" border="0">
        	<h:outputText  style="font-family: Verdana, Arial, Helvetica, sans-serif;  font-weight: bold; font-size: 18px; color: #2F4F4F;" value="Введите ссылку на гит репозиторий"/> <br/>
        	<h:outputText style="font-family: Verdana, Arial, Helvetica, sans-serif; color: #2F4F4F; font-size: 12px;" value="(например, https://github.com/sidgrouse/LetsDoStuff.git)"/> <br/> <br/>
        	<h:inputText value="#{Repo.link}" size="50"/>
        </h:panelGrid>
        <br/>
        <br/>
        <h:commandButton value="Построить графики" action="#{Repo.calculateAll}"/>  
        <br/>
        <br/>
        <br/>

        <h:inputHidden value="#{Repo.resultData}" id="hiddenId" />
        <h:outputScript name="js/d3.min.js"/>
        <h:outputScript name="js/jquery.min.js"/>
		 <h:outputScript>
var svg, group;


var JSONItems = JSON.parse(document.getElementById("j_idt4:hiddenId").value);

(function(){
  svg = d3.select('body').append('svg').attr('width', window.innerWidth).attr('height',window.innerHeight);
  group = svg.append('g');
  createTreemap(JSONItems);
})();


function createTreemap(JSONItems) {
  
  var root = d3.hierarchy(JSONItems);

var treemapLayout = d3.treemap()
  .size([1000, 800])
  .paddingOuter(25);;

var root = d3.hierarchy(JSONItems);

root.sum(function(d) {
  return d.value;
});

treemapLayout(root);

d3.select('svg g')
  .selectAll('rect')
  .data(root.descendants())
  .enter()
  .append('rect')
  .attr('x', function(d) { return d.x0; })
  .attr('y', function(d) { return d.y0; })
  .attr('width', function(d) { return d.x1 - d.x0; })
  .attr('height', function(d) { return d.y1 - d.y0; })
  .style("stroke", "black")
  .style("fill", function(d){ if(d.data.name.slice(-1) == 0) return "#FF0033"; if (d.data.name.slice(-1) == 1) return "#FFFF55"; return "#99FF33";} )
  .append('title')
  .text(function(d) {return d.data.name; });
  

        

 
  
}
		</h:outputScript>
		
		<ui:repeat value="#{Repo.dataForEachPerson}" var="personData" varStatus="myVarStatus">
    	
    	<h:inputHidden value="#{personData}" id="hiddenId1" />
    	<h:outputScript>

var svg = d3.select("body").append("svg")
          .attr("height","100%")
          .attr("width","100%");
        	
        	var dataArray = JSON.parse(document.getElementById("j_idt4:j_idt19:#{myVarStatus.index}:hiddenId1").value);
        	


    svg.selectAll("rect")
    .data(dataArray)
    .enter().append("rect")
          .attr("class", "bar")
          .attr("height", function(d, i) {return (d.value)})
          .attr("width","40")
          .attr("x", function(d, i) {return (i * 60) + 25})
          .attr("y", function(d, i) {return 200 - d.value })
          .style("stroke", "black")
        .style("fill", function(d){ if(d.value &lt; 75) return "#FF0033"; if (d.value &lt; 90) return "#FFFF55"; return "#99FF33";} )
        .append('title')
  		.text(function(d) {return d.title; });
   

svg.selectAll("text")
    .data(dataArray)
    .enter().append("text")
    .text(function(d) {return d.value})
          .attr("x", function(d, i) {return (i * 60) + 30})
          .attr("y", function(d, i) {return 190 - d.value});
    

        	
        </h:outputScript>
</ui:repeat>
		

		

    </h:form>
  

</body>
</html>